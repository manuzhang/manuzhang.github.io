<html><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="Static Blog generated in Scala" /><title>ManuZhang's Blog</title><link rel="shortcut icon" href="favicon.png" /><link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css" /><link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css" /><link rel="stylesheet" href="../../themes/styles.css" /><link rel="stylesheet" href="../../themes/prism.css" /><script src="../../themes/prism.js"></script></head><body><div id="layout" class="pure-g"><div class="sidebar pure-u-1 pure-u-md-1-4"><div class="header"><h1 class="brand-title">ManuZhang's Blog</h1><h2 class="brand-tagline">Static Blog generated in Scala</h2><nav class="nav"><ul class="nav-list"><li class="nav-item"><a class="pure-button" href="https://github.com/manuzhang">GitHub</a></li><li class="nav-item"><a class="pure-button" href="https://twitter.com/manuzhang">Twitter</a></li><li class="nav-item"><a class="pure-button" href="rss/index.xml">RSS</a></li></ul></nav></div></div><div class="content pure-u-1 pure-u-md-3-4"><div><div><h1>Fixing one Spark bug lead to another</h1><p>2019-03-24<a class="home" href="../../">Home</a></p></div><p>As we mentioned in the <a href="https://manuzhang.github.io/2019/02/23/spark-app-npe.html">last post</a>, Spark had a bug checking whether an application has extended <code class='language-text'>scala.App</code> (<a href="https://issues.apache.org/jira/browse/SPARK-26977">SPARK-26977</a>). I went on to submit a <a href="https://github.com/apache/spark/pull/23903">pull request</a> checking the existence of <code class='language-text'>childMainClass$</code> on <code class='language-text'>spark-submit --class childMainClass</code>.</p>
<pre><code class="language-scala">      Try {
        if (classOf[scala.App].isAssignableFrom(Utils.classForName(s&quot;$childMainClass$$&quot;))) {
          logWarning(&quot;Subclasses of scala.App may not work correctly. &quot; +
            &quot;Use a main() method instead.&quot;)
        }
      }
      // invoke main method of childMainClass
</code></pre>
<p>This was a minor issue but since it's my first PR to Spark I was quite happy about it. I didn't realize then when fixing one minor Spark bug I created a major one.</p>
<p>That's <a href="https://issues.apache.org/jira/browse/SPARK-27205">SPARK-27205</a>, where launching <code class='language-text'>spark-shell</code> with <code class='language-text'>--packages</code> option failed to load transitive dependencies on master.</p>
<pre><code class="language-text">./bin/spark-shell --packages org.apache.spark:spark-sql-kafka-0-10_2.11:2.4.0
</code></pre>
<p>Weirdly, it would work after <a href="https://github.com/apache/spark/pull/24147">removing my changes</a>. The two looked irrelevant so I dug into how <code class='language-text'>spark-shell</code> load dependencies behind the scene.</p>
<p><code class='language-text'>spark-shell</code> is actually a shorthand for <code class='language-text'>spark-submit --class org.apache.spark.repl.Main</code> and <a href="https://github.com/apache/spark/blob/master/repl/src/main/scala/org/apache/spark/repl/Main.scala">repl.Main</a> loads user specified jars or packages from <code class='language-text'>spark.repl.local.jars</code> option of <code class='language-text'>SparkConf</code>. The option is set with <code class='language-text'>--jars</code> or <code class='language-text'>--packages</code> from <code class='language-text'>SparkSubmit</code>. I verified the option existed with user packages at <code class='language-text'>SparkSubmit</code>'s side so the issue was that somehow <code class='language-text'>SparkConf</code> didn't get to <code class='language-text'>repl.Main</code>.</p>
<p>It turns out that all options of <code class='language-text'>SparkConf</code> are <a href="https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/deploy/SparkApplication.scala#L47">set to system properties right before invoking the main method</a> of <code class='language-text'>repl.Main</code> and loaded back into <code class='language-text'>SparkConf</code> at initialization of <code class='language-text'>repl.Main</code>. The latter has to <strong>happen after</strong> the former while &quot;my fix&quot; broke it !</p>
<p>Okay, I have been bitten twice by fields initialization of Scala Object.</p>
</div><div class="footer pure-u-1"><span>Generated with <a href="https://github.com/manuzhang/sbg">SBG.</a> Written in Scala</span></div></div></div></body></html>