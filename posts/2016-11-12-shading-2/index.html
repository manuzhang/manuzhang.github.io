<html><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="Static Blog generated in Scala" /><title>ManuZhang's Blog</title><link rel="shortcut icon" href="favicon.png" /><link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css" /><link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css" /><link rel="stylesheet" href="../../themes/styles.css" /><link rel="stylesheet" href="../../themes/prism.css" /><script src="../../themes/prism.js"></script></head><body><div id="layout" class="pure-g"><div class="sidebar pure-u-1 pure-u-md-1-4"><div class="header"><h1 class="brand-title">ManuZhang's Blog</h1><h2 class="brand-tagline">Static Blog generated in Scala</h2><nav class="nav"><ul class="nav-list"><li class="nav-item"><a class="pure-button" href="https://github.com/manuzhang">GitHub</a></li><li class="nav-item"><a class="pure-button" href="https://twitter.com/manuzhang">Twitter</a></li><li class="nav-item"><a class="pure-button" href="rss/index.xml">RSS</a></li></ul></nav></div></div><div class="content pure-u-1 pure-u-md-3-4"><div><div><h1>Shade with SBT II</h1><p>2016-11-12<a class="home" href="../../">Home</a></p></div><p>Previously, we talked about <a href="http://manuzhang.github.io/2016/10/15/shading.html">how we shaded Gearpump dependencies with SBT</a>. One thing I didn't see or mention at that time is that the compilation of depending projects could fail since the shading of depended libraries happen simultaneously. I tried enforcing shade first with tricks like SBT's <a href="http://www.scala-sbt.org/0.13/docs/Howto-Sequential-Task.html">sequential task</a> but that didn't work (At least, I don't know how to). Finally, I went to <a href="http://stackoverflow.com/questions/40397065/how-to-shade-before-compile-with-sbt">Stackoverflow</a> for last resort and <a href="http://stackoverflow.com/users/1870803/yuval-itzchakov">Yuval Itzchakov</a> saved my day with his answer that I should shade the depending project along with its dependencies.</p>
<p>Remember the shaded libraries were depended as <code class='language-text'>unmanagedJars</code> and we had to manually add the dependencies to the published pom of the depending project. Now the problem is kind of the opposite. The dependencies are already assembled and published as a uber jar with the depending codes. Now that being <em>managed dependencies</em> they also end up in the published pom. Hence, we need to manually remove the dependencies in <code class='language-text'>pomPostProcess</code>.</p>
<p>One more subtlety here is <code class='language-text'>gearpump-streaming</code> depends on <code class='language-text'>gearpump-core</code> with both <code class='language-text'>test</code> and <code class='language-text'>provided</code> dependencies. The published pom, however, only contains the <code class='language-text'>test</code> dependency. I haven't found a cleaner way than again <em>manually</em> added it. I also posted <a href="http://stackoverflow.com/questions/40526420/sbt-published-maven-file-missing-artifacts-with-multiple-scopes">a question to Stackoverflow</a>.</p>
<p>One one more thing is <code class='language-text'>java.lang.VerifyError</code> exceptions are thrown by JVM after the change. The work-around is adding <code class='language-text'>-noverify</code> in the JVM options. I haven't yet found the root cause and the issue is logged at <a href="https://issues.apache.org/jira/browse/GEARPUMP-236">GEARPUMP-236</a>.</p>
<p>I have a feeling that there will be a third episode of our story with sbt shade.</p>
</div><div class="footer pure-u-1"><span>Generated with <a href="https://github.com/manuzhang/sbg">SBG.</a> Written in Scala</span></div></div></div></body></html>